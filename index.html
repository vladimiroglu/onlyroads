<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OnlyRoads — Beta</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-curve"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
  --bg:#0b1c3a; --header:#081733;
  --ink:#e6ecff; --ink-dim:#c9d6ff;
  --panel:#0e2349; --panelBorder:#2a3c67;
  --accent:#45a3ff;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

/* Header reveal */
header{position:sticky;top:0;background:var(--header);border-bottom:1px solid #1f3159;box-shadow:0 6px 18px rgba(0,0,0,.28);z-index:10000;transition:transform 220ms ease;will-change:transform}
header.is-hidden{transform:translateY(-100%)} header.force-show{transform:translateY(0)!important}
.header-inner{max-width:980px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:10px 12px 8px}
.brand{font-family:Impact,Haettenschweiler,"Arial Black",Anton,system-ui,sans-serif;font-weight:800;letter-spacing:.3px;font-size:clamp(18px,4.8vw,26px)}

/* Kebab (SVG) */
.icon-btn{width:44px;height:44px;border-radius:12px;border:1px solid #263a6a;background:#112553;color:#fff;display:grid;place-items:center;cursor:pointer}
.icon-btn:hover{background:#153063}
.icon-btn svg{width:20px;height:20px;display:block;fill:#fff;opacity:.95}

/* Layout */
.wrap{max-width:980px;margin:0 auto;padding:8px 12px 18px}
.map-wrap{position:relative}
#map{width:100%;aspect-ratio:21/7;min-height:200px;border-radius:14px;border:1px solid #233a6b;background:#0e2349;margin:8px 0 6px;overflow:hidden;position:relative}
#mapCounter{position:absolute;left:12px;bottom:12px;background:rgba(8,23,51,.88);color:#fff;border:1px solid #ffffff2d;padding:6px 10px;border-radius:10px;font:800 clamp(14px,3.8vw,18px)/1 Impact,system-ui,sans-serif;letter-spacing:.5px}
#fabAddTrip{position:absolute;right:12px;bottom:12px;z-index:2;width:46px;height:46px;border-radius:14px;border:1px solid #284079;background:#16306a;color:#fff;font-size:24px;font-weight:700;display:grid;place-items:center;cursor:pointer}
#fabAddTrip:hover{background:#1a3a80}

/* Hide badges while exporting + neutralize fine-scale for screenshot */
body.exporting #mapCounter, body.exporting #fabAddTrip{visibility:hidden}
body.exporting #map .leaflet-map-pane{ transform:none !important; }

/* Clickable hint */
#belowHint{display:none;margin:8px 2px 12px;padding:16px 14px;border:2px dotted var(--panelBorder);border-radius:12px;background:transparent;color:var(--ink-dim);text-align:center;font-size:14px;letter-spacing:.2px;cursor:pointer;user-select:none}
#belowHint:active{transform:scale(.99)}

/* Trip bar */
.tripbar{display:none;align-items:center;gap:10px;margin:8px 0;flex-wrap:nowrap}
.tripbar.show{display:flex}
.tripbar .tripname{flex:1;min-width:0;background:var(--panel);border:1px solid var(--panelBorder);color:var(--ink);border-radius:12px;padding:10px 12px;font-size:15px;height:42px;line-height:20px}
.mini{width:42px;height:42px;border-radius:12px;border:1px solid var(--panelBorder);background:#1a2f5a;color:#fff;display:grid;place-items:center;cursor:pointer;flex:0 0 auto}
.mini:hover{background:#21366a}
.mini .color-chip{width:22px;height:22px;border-radius:6px;border:1px solid #ffffff55;display:block}
.mini svg{width:18px;height:18px;display:block;stroke:#fff;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

/* City controls + autocomplete */
.controls{display:none;gap:10px;position:relative}
.controls.show{display:flex}
.controls input{flex:1;background:var(--panel);border:1px solid var(--panelBorder);color:var(--ink);border-radius:10px;padding:12px 14px;font-size:16px}
.ac{position:absolute;top:48px;left:0;right:0;z-index:5000;background:var(--panel);border:1px solid var(--panelBorder);border-radius:10px;max-height:260px;overflow:auto;display:none;box-shadow:0 12px 30px rgba(0,0,0,.35)}
.ac.show{display:block}
.ac-item{padding:10px 12px;border-bottom:1px solid #192d56;cursor:pointer}
.ac-item:hover{background:#153063}

/* City list */
.list{display:none;margin-top:10px;border:1px dashed var(--panelBorder);border-radius:12px;padding:8px;min-height:60px;position:relative}
.list.show{display:block}
.li{display:flex;align-items:center;gap:10px;background:#102652;border:1px solid #233a6b;color:var(--ink);padding:10px 12px;border-radius:10px;margin:6px 0;cursor:grab}
.li .handle{font-size:18px;opacity:.8}
.li .name{flex:1}
.li .remove{background:transparent;border:none;color:#cdd6ff;font-size:18px;cursor:pointer}
.li.li-selected{background:#224080}
.empty-list-hint{position:absolute;inset:0;display:none;place-items:center;color:#c9d6ff;opacity:.9;font-size:13px}

/* Legend */
.legend{display:none;flex-wrap:wrap;gap:10px;margin:6px 2px 0}
.legend.show{display:flex}
.legend .item{display:flex;align-items:center;gap:8px;background:#0f2550;border:1px solid #223a6c;padding:6px 10px;border-radius:12px;font-size:13px;color:var(--ink-dim);cursor:pointer;outline:none}
.legend .item:hover{background:#153063}
.legend .item.is-active{border-color:#3a58a2;color:#e8f0ff;box-shadow:0 0 0 2px #3a58a215 inset}
.legend .chip{width:14px;height:14px;border-radius:50%;border:1px solid #fff6}

/* Menu (anchored to kebab) */
.menu{position:fixed;z-index:11000;background:#0f2550;border:1px solid #223a6c;border-radius:12px;min-width:230px;display:none;box-shadow:0 12px 30px rgba(0,0,0,.35);overflow:hidden}
.menu.show{display:block}
.mi{padding:10px 14px;border-bottom:1px solid #193566;cursor:pointer;font-size:14.5px;letter-spacing:.2px}
.mi:last-child{border-bottom:none}
.mi:hover{background:#153063}

.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#102652;color:#fff;border:1px solid #223a6c;border-radius:10px;padding:10px 14px;z-index:12000;display:none}
.toast.show{display:block}
footer{color:#9fb0df65;text-align:center;font-size:12px;padding:10px 0 16px}

/* Color picker */
.cp-pop{position:absolute;z-index:12000;background:#0f2550;border:1px solid #223a6c;border-radius:12px;padding:10px;box-shadow:0 12px 30px rgba(0,0,0,.35);width:min(260px, 92vw)}
.cp-row{display:flex;flex-wrap:wrap;gap:10px}
.cp-swatch{width:28px;height:28px;border-radius:8px;border:1px solid #ffffff55;cursor:pointer}
.cp-actions{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
.cp-chip{display:inline-grid;grid-auto-flow:column;gap:8px;align-items:center;background:#1a2f5a;border:1px solid var(--panelBorder);color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
.cp-chip input[type="color"]{appearance:none;border:none;background:transparent;width:0;height:0;padding:0;margin:0}
.cp-btn{background:#1a2f5a;border:1px solid var(--panelBorder);color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
.cp-btn:hover,.cp-chip:hover{background:#21366a}

/* Visual effects */
.or-states-glow path{
  filter:
    drop-shadow(0 0 2px rgba(255,255,255,.65))
    drop-shadow(0 0 6px rgba(255,255,255,.35))
    drop-shadow(0 0 12px rgba(255,255,255,.22));
}
.or-marker-glow{ filter:url(#or-soft-glow); }
.or-state-inner{ filter:url(#or-inner-shadow); }

/* Desktop readability tweaks */
@media (min-width:900px){
  .brand{letter-spacing:1.3px;font-stretch:condensed;transform:scaleX(.78);transform-origin:left center;-webkit-text-stroke:1.1px rgba(230,236,255,.42);text-shadow:0 1px 0 rgba(0,0,0,.25)}
  #mapCounter{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-weight:900;font-size:16px;letter-spacing:.35px;padding:5px 9px;transform:scaleX(.92);transform-origin:left center}
}
</style>
</head>
<body>
<!-- SVG filters -->
<svg width="0" height="0" style="position:absolute;left:-9999px;top:-9999px" aria-hidden="true" focusable="false">
  <defs>
    <filter id="or-soft-glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur stdDeviation="2.8" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
    <filter id="or-inner-shadow" x="-50%" y="-50%" width="200%" height="200%">
      <feOffset dx="0" dy="1" in="SourceAlpha" result="off"/>
      <feGaussianBlur in="off" stdDeviation="2.5" result="blur"/>
      <feColorMatrix in="blur" type="matrix"
        values="0 0 0 0 0
                0 0 0 0 0
                0 0 0 0 0
                0 0 0 .55 0" result="shadow"/>
      <feComposite in="shadow" in2="SourceAlpha" operator="in" result="inner"/>
      <feComposite in="SourceGraphic" in2="inner" operator="over"/>
    </filter>
  </defs>
</svg>

<header>
  <div class="header-inner">
    <div class="brand">OnlyRoads</div>
    <button class="icon-btn" id="kebabBtn" aria-label="More">
      <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="5" cy="12" r="2.2"/><circle cx="12" cy="12" r="2.2"/><circle cx="19" cy="12" r="2.2"/></svg>
    </button>
    <div class="menu" id="menu">
      <div class="mi" id="miSave">Save image</div>
      <div class="mi" id="miShare">Share link</div>
      <div class="mi" id="miFeedback">Leave feedback</div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="map-wrap" id="mapWrap">
    <div id="map"></div>
    <div id="mapCounter">0/50</div>
    <button id="fabAddTrip" title="New Trip" aria-label="New Trip">+</button>
  </div>

  <div id="belowHint" role="button" tabindex="0" aria-label="Create a trip">Tap + to create your first trip</div>

  <div class="tripbar" id="tripBar">
    <select id="tripSelect" class="tripname" aria-label="Select trip"></select>
    <button class="mini" id="tripColorBtn" title="Trip color" aria-label="Trip color"><span id="tripColorChip" class="color-chip"></span></button>
    <button class="mini" id="renameTripBtn" title="Rename trip" aria-label="Rename trip"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 21h4l11-11-4-4L3 17v4z"/><path d="M14 6l4 4"/></svg></button>
    <button class="mini" id="deleteTripBtn" title="Delete trip" aria-label="Delete trip"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M6 6l1 14h10l1-14"/></svg></button>
  </div>

  <div class="controls" id="controls">
    <input id="cityInput" placeholder="Type a U.S. city to add" aria-label="City search"/>
    <div id="ac" class="ac" role="listbox" aria-label="City results"></div>
  </div>

  <div class="list" id="cityList"><div id="emptyListHint" class="empty-list-hint"></div></div>
  <div class="legend" id="legend"></div>
</div>

<footer id="footerNote"></footer>
<div class="toast" id="toast" role="status" aria-live="polite"></div>

<!-- Color picker popover -->
<div id="colorPicker" class="cp-pop" hidden>
  <div class="cp-row" id="cpSwatches"></div>
  <div class="cp-actions">
    <label class="cp-chip"><input type="color" id="cpCustom" aria-label="Custom color"/>Custom…</label>
    <button id="cpClose" class="cp-btn">Done</button>
  </div>
</div>

<script>
/* ===== Version constant ===== */
const VERSION = '0.085';
document.addEventListener('DOMContentLoaded', ()=>{
  document.title = `OnlyRoads — Beta v${VERSION}`;
  document.getElementById('footerNote').textContent = `OnlyRoads Beta v${VERSION} - Emin's personal project`;
});

/* ===== Constants / helpers ===== */
const STATE_ABBR={"Alabama":"AL","Alaska":"AK","Arizona":"AZ","Arkansas":"AR","California":"CA","Colorado":"CO","Connecticut":"CT","Delaware":"DE","District of Columbia":"DC","Florida":"FL","Georgia":"GA","Hawaii":"HI","Idaho":"ID","Illinois":"IL","Indiana":"IN","Iowa":"IA","Kansas":"KS","Kentucky":"KY","Louisiana":"LA","Maine":"ME","Maryland":"MD","Massachusetts":"MA","Michigan":"MI","Minnesota":"MN","Mississippi":"MS","Missouri":"MO","Montana":"MT","Nebraska":"NE","Nevada":"NV","New Hampshire":"NH","New Jersey":"NJ","New Mexico":"NM","New York":"NY","North Carolina":"NC","North Dakota":"ND","Ohio":"OH","Oklahoma":"OK","Oregon":"OR","Pennsylvania":"PA","Rhode Island":"RI","South Carolina":"SC","South Dakota":"SD","Tennessee":"TN","Texas":"TX","Utah":"UT","Vermont":"VT","Virginia":"VA","Washington":"WA","West Virginia":"WV","Wisconsin":"WI","Wyoming":"WY"};
const ABBR_TO_NAME=Object.fromEntries(Object.entries(STATE_ABBR).map(([k,v])=>[v,k]));
function canonicalStateName(n){ if(!n) return null; const s=String(n).trim();
  if(STATE_ABBR[s]) return s; const ab=s.toUpperCase(); if(ABBR_TO_NAME[ab]) return ABBR_TO_NAME[ab];
  if(["washington, d.c.","district of columbia","washington dc"].includes(s.toLowerCase())) return "District of Columbia";
  return s;
}
const PALETTE=['#45a3ff','#ff6b6b','#ffd166','#06d6a0','#c792ea','#ff9f1c','#00bcd4','#ef476f','#8ac926','#a0a0ff'];

const DOT_RADIUS=3.5, DOT_WEIGHT=1, RED='#ff0000', GREEN='#30e6b6';

/* === Curve tuning === */
let CURVE_GAIN = 1.05; /* gentler than before */
const ROUTE_WEIGHT = 3;

/* Poster defaults */
const POSTER_W = 1080, POSTER_H = 1920;
const POSTER_BG = '#0b1c3a';
const WATERMARK_TEXT = 'OnlyPages';

/* ===== POSTER LAYOUT TUNABLES =====
   Tweak these numbers to adjust the whole layout quickly.
   All positions are in poster pixels (1080x1920). */
const POSTER_LAYOUT = {
  SAFE_TOP: 250,
  SAFE_BOTTOM: 250,

  headerLeftX: 60,
  headerTopY: 50,          // relative to SAFE_TOP

  bigNumberRightPad: 60,   // distance from right edge
  bigNumberGap: 18,        // space between big number and "/ 50"

  mapCard: {               // rounded rectangle box for the map
    topGapFromHeader: 40,  // below the second "UNLOCKED" line
    maxH: 620,             // cap map box height
    sidePad: 40,           // horizontal padding inside the poster
    radius: 36,            // card corner radius
    shadowBlur: 30,
    shadowOffsetY: 14
  },

  listHeaderGap: 54,       // gap under the map card
  listStartGap: 64,        // gap under list header
  bullet: { dashW: 86, dashH: 12, dashOffsetY: -22, lineGap: 64 },

  watermarkRightPad: 24,   // from right edge
  watermarkRaise: 10       // raise a touch into the safe area
};
/* ================================== */

/* Refs */
const mapCounter=document.getElementById('mapCounter');
const belowHint=document.getElementById('belowHint');
const tripBar=document.getElementById('tripBar'),
      tripSelect=document.getElementById('tripSelect'),
      tripColorChip=document.getElementById('tripColorChip'),
      tripColorBtn=document.getElementById('tripColorBtn');

const controls=document.getElementById('controls'),
      input=document.getElementById('cityInput'),
      ac=document.getElementById('ac');

const list=document.getElementById('cityList'), emptyListHint=document.getElementById('emptyListHint');
const legendEl=document.getElementById('legend');
function toast(t){const el=document.getElementById('toast'); el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1600);}

/* ===== App state ===== */
let trips=[],activeTripId=null,tripCounter=0,cidCounter=0,selectedId=null;
function getActiveTrip(){return trips.find(t=>t.id===activeTripId);}

/* ===== Menu (anchored) ===== */
const kebabBtn=document.getElementById('kebabBtn'); const menu=document.getElementById('menu');
function positionMenu(){
  if(!menu.classList.contains('show')) return;
  const r=kebabBtn.getBoundingClientRect();
  const margin=8;
  const left=Math.min(Math.max(8, r.right - menu.offsetWidth), window.innerWidth - menu.offsetWidth - 8);
  const top=Math.min(r.bottom + margin, window.innerHeight - menu.offsetHeight - 8);
  menu.style.left = `${left}px`; menu.style.top = `${top}px`;
}
kebabBtn.addEventListener('click',(e)=>{ e.stopPropagation(); const willShow=!menu.classList.contains('show'); if(willShow){ menu.classList.add('show'); positionMenu(); } else { menu.classList.remove('show'); }});
window.addEventListener('resize', positionMenu);
window.addEventListener('scroll', positionMenu, {passive:true});
document.addEventListener('click',e=>{ if(!menu.contains(e.target)&&e.target!==kebabBtn) menu.classList.remove('show'); });

/* ===== Trips UI ===== */
function refreshTripUI(){
  tripSelect.innerHTML='';
  trips.forEach(t=>{const o=document.createElement('option');o.value=t.id;o.textContent=t.name;if(t.id===activeTripId)o.selected=true;tripSelect.appendChild(o);});
  const act=getActiveTrip(); tripColorChip.style.background = act ? act.color : 'transparent';
  renderLegend();
}
tripSelect.addEventListener('change',()=>{activeTripId=+tripSelect.value||null; renderList(); updateMap(); updateEmptyState(); highlightLegendActive();});

/* Empty state */
function updateEmptyState(){
  const hasTrip = trips.length>0;
  belowHint.style.display = hasTrip ? 'none' : 'block';
  tripBar.classList.toggle('show', hasTrip);
  controls.classList.toggle('show', hasTrip);
  list.classList.toggle('show', hasTrip);
  legendEl.classList.toggle('show', hasTrip);
}

/* Create / rename / delete trip */
function createTripFlow(){
  const raw=prompt('Name your new trip:', '');
  if(raw===null) return;
  const name=(raw||'').trim();
  addTrip(name||undefined, PALETTE[(tripCounter)%PALETTE.length]);
}
function addTrip(name,color){
  const id=++tripCounter;
  trips.push({id,name:name||`Trip ${id}`,color:color||PALETTE[(id-1)%PALETTE.length],cities:[]});
  activeTripId=id; refreshTripUI(); renderList(); recomputeUnlockedFromCities(); updateMap(); updateEmptyState(); toast(`Created trip “${getActiveTrip().name}”`);
}
document.getElementById('fabAddTrip').addEventListener('click', createTripFlow);
belowHint.addEventListener('click', createTripFlow);

document.getElementById('renameTripBtn').addEventListener('click',()=>{
  const t=getActiveTrip(); if(!t){toast('No trip');return;}
  const raw=prompt('Rename trip:', t.name||''); if(raw===null)return; const n=raw.trim(); if(n){t.name=n; refreshTripUI();}
});
document.getElementById('deleteTripBtn').addEventListener('click',()=>{
  const t=getActiveTrip(); if(!t) return; if(!confirm(`Delete “${t.name}”?`)) return;
  trips=trips.filter(x=>x.id!==t.id); activeTripId=trips.length?trips[trips.length-1].id:null;
  recomputeUnlockedFromCities(); updateMap(); renderList(); refreshTripUI(); updateEmptyState();
});

/* ===== Color picker ===== */
const cp=document.getElementById('colorPicker'), cpSwatches=document.getElementById('cpSwatches'), cpCustom=document.getElementById('cpCustom'), cpClose=document.getElementById('cpClose');
(function initColorPicker(){
  cpSwatches.innerHTML='';
  PALETTE.forEach(hex=>{
    const b=document.createElement('button'); b.className='cp-swatch'; b.style.background=hex; b.setAttribute('aria-label',`Choose ${hex}`);
    b.addEventListener('click', ()=>applyTripColor(hex,true)); cpSwatches.appendChild(b);
  });
  function positionPopover(){ const r=tripColorBtn.getBoundingClientRect(); cp.style.top=`${r.bottom+window.scrollY+8}px`; const maxLeft=window.scrollX+document.documentElement.clientWidth-cp.offsetWidth-8; cp.style.left=`${Math.min(r.left+window.scrollX,maxLeft)}px`; }
  function openPopover(){ if(cp.hidden){ cp.hidden=false; requestAnimationFrame(positionPopover); } }
  function closePopover(){ cp.hidden=true; }
  tripColorBtn.addEventListener('click',(e)=>{ e.stopPropagation(); openPopover(); });
  cpClose.addEventListener('click', closePopover);
  cpCustom.addEventListener('input', ()=> applyTripColor(cpCustom.value, true));
  document.addEventListener('click',(e)=>{ if(!cp.hidden && !cp.contains(e.target) && e.target!==tripColorBtn) closePopover(); });
  window.addEventListener('resize', ()=>{ if(!cp.hidden) positionPopover(); });
})();
function applyTripColor(hex,persist){ const t=getActiveTrip(); if(!t) return; t.color=hex; tripColorChip.style.background=hex; renderLegend(); updateMap(); }

/* ===== Autocomplete (minimal) ===== */
let acTimer=null;
input.addEventListener('input', ()=>{
  const q=input.value.trim();
  clearTimeout(acTimer);
  if(!q){ac.classList.remove('show');ac.innerHTML='';return;}
  acTimer=setTimeout(()=>fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&countrycodes=us&limit=6&q=${encodeURIComponent(q)}`)
    .then(r=>r.json()).then(rows=>{
      ac.innerHTML='';
      const items=rows.map(row=>{
        const a=row.address||{}; const cityName=a.city||a.town||a.village||a.hamlet||row.display_name.split(',')[0];
        const stateFull=canonicalStateName(a.state||''); const ab=STATE_ABBR[stateFull]||'';
        if(!cityName||!ab||!stateFull) return null;
        return {label:`${cityName}, ${ab}`, name:cityName, stateFull, stateAbbr:ab, lat:+row.lat, lon:+row.lon};
      }).filter(Boolean);
      if(!items.length){ac.classList.remove('show');return;}
      items.forEach(it=>{const d=document.createElement('div'); d.className='ac-item'; d.textContent=it.label; d.onclick=()=>{ac.classList.remove('show');input.value='';addCity(it);}; ac.appendChild(d);});
      ac.classList.add('show');
    }).catch(()=>{}),200);
});
document.addEventListener('click',e=>{ if(!ac.contains(e.target)&&e.target!==input) ac.classList.remove('show'); });

/* ===== Sortable list ===== */
new Sortable(list,{handle:'.li',animation:150,
  onChoose:e=>{selectedId=+e.item.dataset.id;updateSelectionVisuals();},
  onEnd:()=>{const t=getActiveTrip();if(!t)return;const ids=[...list.children].filter(n=>n.classList.contains('li')).map(li=>+li.dataset.id);t.cities.sort((a,b)=>ids.indexOf(a.id)-ids.indexOf(b.id));updateMap();}
});
function renderList(){
  list.querySelectorAll('.li').forEach(n=>n.remove());
  const t=getActiveTrip(); if(!t){emptyListHint.style.display='none';return;}
  if(t.cities.length===0){emptyListHint.style.display='grid'; emptyListHint.textContent='Add cities using the box above';}
  else emptyListHint.style.display='none';
  t.cities.forEach(c=>{
    const row=document.createElement('div'); row.className='li'; row.dataset.id=c.id;
    row.innerHTML=`<div class="handle">⋮⋮</div><div class="name">${c.name}, ${c.stateAbbr}</div><button class="remove">×</button>`;
    row.querySelector('.remove').onclick=(ev)=>{ev.stopPropagation(); removeCityById(c.id);};
    row.addEventListener('click',(ev)=>{ if(ev.target.closest('.remove'))return; selectedId=(selectedId===c.id?null:c.id); updateSelectionVisuals(); });
    if(selectedId===c.id) row.classList.add('li-selected');
    list.appendChild(row);
  });
}

/* ===== Map / drawing ===== */
let map, statesGlowLayer, statesLayer, stateLayerByName={}, conusBounds=null;
let markerById={}, routeLines={}, unlockedStates=new Set();

/* Desktop map fine-scaling/nudges */
const MAP_FINE_SCALE = 0.85;
const MAP_Y_NUDGE   = -213;
const MAP_X_NUDGE   = -50;
const FINE_SCALE_MIN_W = 900;
function fineScaleActive(){ return window.innerWidth >= FINE_SCALE_MIN_W; }

/* Auto-fit tuning */
const AUTO_FIT = { OVERSCAN: 1.06, PAD: 8 };

function initMap(){
  map=L.map('map',{zoomControl:false,attributionControl:false,dragging:false,scrollWheelZoom:false,doubleClickZoom:false,boxZoom:false,keyboard:false,touchZoom:false});
  map.createPane('statesGlowPane');
  map.createPane('statesPane');
  map.createPane('routesPane');
  map.createPane('markersPane');

  fetch("https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json")
    .then(r=>r.json()).then(geo=>{
      const conus=geo.features.filter(f=>!["Alaska","Hawaii","Puerto Rico"].includes(f.properties.name));

      statesGlowLayer=L.geoJSON({type:"FeatureCollection",features:conus},{
        pane:'statesGlowPane',
        style:()=>({color:'#ffffff',weight:1,opacity:0.9,fillOpacity:0,className:'or-states-glow'}),
      }).addTo(map);

      statesLayer=L.geoJSON({type:"FeatureCollection",features:conus},{
        pane:'statesPane',
        style:()=>({color:'#ffffff',weight:1,fillColor:'#0b1c3a',fillOpacity:1}),
        onEachFeature:(f,l)=>{stateLayerByName[f.properties.name]=l;}
      }).addTo(map);

      const tmp=L.geoJSON({type:"FeatureCollection",features:conus}); conusBounds=tmp.getBounds();
      autoFitUSHeight(); refreshAllStateStyles(); updateMap();
      map.on('move zoom viewreset moveend zoomend', applyFineScale);
    });
}
function _usPixelHeightAtZoom(bounds, z){ const ne = map.project(bounds.getNorthEast(), z); const sw = map.project(bounds.getSouthWest(), z); return Math.abs(ne.y - sw.y); }
function autoFitUSHeight(){
  if(!conusBounds || !map) return;
  map.invalidateSize(false);
  const padY = AUTO_FIT.PAD * 2;
  const targetH = Math.max(1, map.getSize().y - padY);
  const wantedH = targetH * AUTO_FIT.OVERSCAN;
  let zMin = 0, zMax = 22;
  for (let i = 0; i < 25; i++) {
    const zMid = (zMin + zMax) / 2;
    const h = _usPixelHeightAtZoom(conusBounds, zMid);
    if (h < wantedH) zMin = zMid; else zMax = zMid;
  }
  const z = zMin;
  const center = conusBounds.getCenter();
  map.setView(center, z, { animate:false });
  requestAnimationFrame(applyFineScale);
}
window.addEventListener('resize', ()=>{ autoFitUSHeight(); requestAnimationFrame(applyFineScale); }, {passive:true});

function applyFineScale(){
  const pane = map?.getPanes()?.mapPane; if (!pane || !conusBounds) return;
  const base = pane.style.transform || '';
  const cleaned = base.replace(/\s+scale\([^)]+\)/,'').replace(/\s+translateX\([^)]+\)/,'').replace(/\s+translateY\([^)]+\)/,'');
  if (!fineScaleActive()){ pane.style.transformOrigin=''; pane.style.transform=cleaned; return; }

  const z = map.getZoom();
  const cPx = map.project(conusBounds.getCenter(), z);
  const size = map.getSize();
  const pNE = map.project(conusBounds.getNorthEast(), z);
  const pSW = map.project(conusBounds.getSouthWest(), z);
  const hUS = Math.abs(pNE.y - pSW.y);
  const dyCent = (size.y - hUS * MAP_FINE_SCALE) / 2;
  const dy = dyCent + MAP_Y_NUDGE;
  const dx = MAP_X_NUDGE;

  pane.style.transformOrigin = `${cPx.x}px ${cPx.y}px`;
  pane.style.transform = `${cleaned} translateX(${dx}px) translateY(${dy}px) scale(${MAP_FINE_SCALE})`;
}

/* ===== Adaptive curve builder (gentler) ===== */
function _scaledDx(p1,p2){ const avg=((p1[0]+p2[0])/2)*Math.PI/180; return (p2[1]-p1[1])*Math.cos(avg); }
function adaptiveTauFor(p1,p2){
  const dx=Math.abs(_scaledDx(p1,p2)), dy=Math.abs(p2[0]-p1[0]), d=Math.hypot(dx,dy);
  const r=dx/(dx+dy+1e-9);
  // tighter range for gentler curves
  let tau=0.58+(r-0.5)*0.24+Math.min(d/5,1)*0.10;
  return Math.max(0.48,Math.min(0.78,tau));
}
function _controls(p0,p1,p2,p3,tau){
  const dx10=_scaledDx(p0,p1), dx21=_scaledDx(p1,p2), dx32=_scaledDx(p2,p3);
  const k=(tau/6)*CURVE_GAIN;
  const avg1=((p0[0]+p1[0])/2)*Math.PI/180, avg2=((p2[0]+p3[0])/2)*Math.PI/180;
  const c1=[ p1[0]+k*(p2[0]-p0[0]),  p1[1]+k*((dx21+dx10)/(Math.cos(avg1)||1)) ];
  const c2=[ p2[0]-k*(p3[0]-p1[0]),  p1[1]-k*((dx32+dx21)/(Math.cos(avg2)||1)) ];
  return [c1,c2];
}
function buildSmoothPathAdaptive(points,{closed=false}={}){
  if(points.length<2) return null;
  const pts=points.slice();
  if(closed){ pts.unshift(points[points.length-2]||points[0]); pts.push(points[1]||points[0]); }
  else { pts.unshift(points[0]); pts.push(points[points.length-1]); }
  const path=['M', points[0]];
  for(let i=0;i<points.length-1;i++){
    const p0=pts[i], p1=pts[i+1], p2=pts[i+2], p3=pts[i+3];
    const tau=adaptiveTauFor(p1,p2);
    const [c1,c2]=_controls(p0,p1,p2,p3,tau);
    path.push('C', c1, c2, p2);
  }
  if(closed) path.push('Z');
  return path;
}
function isClosed(points){ if(points.length<3) return false; const a=points[0], b=points[points.length-1]; return Math.hypot(a[0]-b[0],a[1]-b[1])<0.6; }

/* ===== Map draw/update ===== */
function markerStyle(isSelected){ return { radius:DOT_RADIUS, color:'#ffffff', weight:DOT_WEIGHT, fillColor:isSelected?GREEN:RED, fillOpacity:1, pane:'markersPane', className:'or-marker-glow', interactive:false }; }
function updateSelectionVisuals(){
  [...list.children].forEach(li=>{ if(!li.classList.contains('li')) return; +li.dataset.id===selectedId ? li.classList.add('li-selected') : li.classList.remove('li-selected');});
  for(const id in markerById){ const m=markerById[id]; if(m){ m.setStyle(markerStyle(+id===selectedId)); } }
}
function updateCounter(){ mapCounter.textContent=`${unlockedStates.size}/50`; }
function recomputeUnlockedFromCities(){
  unlockedStates.clear();
  trips.forEach(t=>t.cities.forEach(c=>{ const canon=canonicalStateName(c.stateFull||c.stateAbbr); if(canon && stateLayerByName[canon]) unlockedStates.add(canon); }));
  updateCounter(); refreshAllStateStyles();
}
function applyStateStyle(name,selected){
  const layer=stateLayerByName[name]; if(!layer) return;
  if(selected){ layer.setStyle({fillColor:'#ffffff',fillOpacity:1,color:'#0b1c3a',weight:2}); }
  else{ layer.setStyle({fillColor:'#0b1c3a',fillOpacity:1,color:'#ffffff',weight:1}); }
  const el = layer.getElement && layer.getElement(); if(el){ el.classList.toggle('or-state-inner', !!selected); }
}
function refreshAllStateStyles(){ Object.keys(stateLayerByName).forEach(n=>applyStateStyle(n,unlockedStates.has(n))); }

function updateMap(){
  if(!map) return;

  // clear
  for(const id in markerById){ if(markerById[id]) map.removeLayer(markerById[id]); }
  markerById={};
  Object.values(routeLines).forEach(l=>{ if(l) map.removeLayer(l); }); routeLines={};

  // markers
  trips.forEach(t=>{
    t.cities.forEach(c=>{ markerById[c.id]=L.circleMarker([c.lat,c.lon], markerStyle(c.id===selectedId)).addTo(map); });
  });

  // routes — one per trip (ALL trips)
  trips.forEach(t=>{
    if(t.cities.length>1){
      const pts=t.cities.map(c=>[c.lat,c.lon]);
      const closed=isClosed(pts);
      const path=buildSmoothPathAdaptive(pts,{closed});
      if(path){
        const line = L.curve(path,{pane:'routesPane',className:'route',color:t.color,weight:ROUTE_WEIGHT});
        routeLines[t.id]=line.addTo(map);
      }
    }
  });

  autoFitUSHeight(); updateSelectionVisuals();
}

/* City add/remove */
function addCity(item){
  const t=getActiveTrip(); if(!t){toast('Create a trip first (tap +)');return;}
  item.id=++cidCounter; t.cities.push(item);
  recomputeUnlockedFromCities(); updateMap(); renderList(); updateSelectionVisuals(); updateEmptyState();
  toast(`Added ${item.name}, ${item.stateAbbr}`);
}
function removeCityById(id){
  const t=getActiveTrip(); if(!t) return;
  const idx=t.cities.findIndex(c=>c.id===id); if(idx===-1) return;
  const removed=t.cities[idx]; t.cities.splice(idx,1);
  if(selectedId===id) selectedId=null;
  recomputeUnlockedFromCities(); updateMap(); renderList(); updateSelectionVisuals(); updateEmptyState();
  toast(`Removed ${removed.name}, ${removed.stateAbbr}`);
}

/* Legend + switching */
function renderLegend(){
  legendEl.innerHTML='';
  trips.forEach(t=>{
    const d=document.createElement('button'); d.className='item'; d.type='button';
    d.setAttribute('data-id', t.id); d.setAttribute('aria-label', `Switch to ${t.name}`); d.tabIndex=0;
    d.innerHTML=`<span class="chip" style="background:${t.color}"></span><span>${t.name}</span>`;
    d.addEventListener('click', ()=> activateTripById(t.id));
    d.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); activateTripById(t.id); }});
    legendEl.appendChild(d);
  });
  legendEl.classList.toggle('show', trips.length>0);
  highlightLegendActive();
}
function highlightLegendActive(){ [...legendEl.children].forEach(el=>{ el.classList.toggle('is-active', +el.getAttribute('data-id')===activeTripId); }); }
function activateTripById(id){
  if (activeTripId === id) return;
  activeTripId = id;
  refreshTripUI(); renderList(); updateMap(); updateEmptyState(); highlightLegendActive();
}

/* ===== Poster helpers ===== */
function haversineMiles(lat1,lon1,lat2,lon2){
  const R=3958.7613, toRad=d=>d*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function totalTripMiles(trip){
  if(!trip || trip.cities.length<2) return 0;
  let miles=0; for(let i=0;i<trip.cities.length-1;i++){ const a=trip.cities[i], b=trip.cities[i+1]; miles += haversineMiles(a.lat,a.lon,b.lat,b.lon); }
  return miles;
}
function formatMiles(m){ return m>=1000 ? `${(m/1000).toFixed(1)}k miles` : `${Math.round(m/10)*10} miles`; }

/* Draw rounded rect helper */
function roundRect(ctx,x,y,w,h,r){ const rr=Math.min(r, w/2, h/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath(); }

/* ===== Build poster (v0.085) ===== */
async function buildPosterCanvas(mapCanvas){
  const P = POSTER_LAYOUT;
  const canvas=document.createElement('canvas'); canvas.width=POSTER_W; canvas.height=POSTER_H;
  const ctx=canvas.getContext('2d');

  // Background
  ctx.fillStyle=POSTER_BG; ctx.fillRect(0,0,POSTER_W,POSTER_H);

  // Safe area
  const topSafe = P.SAFE_TOP;
  const usableH = POSTER_H - P.SAFE_TOP - P.SAFE_BOTTOM;

  /* Header Left */
  const hdrX = P.headerLeftX, hdrY = P.SAFE_TOP + P.headerTopY;
  ctx.fillStyle = '#eaf2ff';
  ctx.textBaseline = 'alphabetic';
  ctx.shadowColor = 'rgba(0,0,0,0.35)'; ctx.shadowBlur = 8; ctx.shadowOffsetY = 2;

  ctx.font='900 96px Impact, Haettenschweiler, "Arial Black", system-ui, sans-serif';
  ctx.fillText('STATES', hdrX, hdrY + 96);
  ctx.fillText('UNLOCKED', hdrX, hdrY + 96 + 84);

  /* Big number right-aligned */
  const unlocked = unlockedStates.size || 0;
  const bigStr = String(unlocked);
  const numBaseY = hdrY + 96 + 70;
  ctx.font = '900 180px Impact, Haettenschweiler, "Arial Black", system-ui, sans-serif';  const bigW = ctx.measureText(bigStr).width;
  ctx.font = '900 84px Impact, Haettenschweiler, "Arial Black", system-ui, sans-serif'; const slashW = ctx.measureText('/ 50').width;
  const totalW = bigW + P.bigNumberGap + slashW;
  const numX = POSTER_W - P.bigNumberRightPad - totalW;
  ctx.font = '900 180px Impact, Haettenschweiler, "Arial Black", system-ui, sans-serif';  ctx.fillText(bigStr, numX, numBaseY);
  ctx.font = '900 84px Impact, Haettenschweiler, "Arial Black", system-ui, sans-serif'; ctx.fillText('/ 50', numX + bigW + P.bigNumberGap, numBaseY - 18);

  /* Map Card (rounded box) */
  const mapTop = hdrY + 96 + 84 + P.mapCard.topGapFromHeader;
  const cardH = Math.min(usableH * 0.50, P.mapCard.maxH);
  const cardX = P.mapCard.sidePad;
  const cardW = POSTER_W - P.mapCard.sidePad*2;

  ctx.save();
  ctx.shadowColor='rgba(0,0,0,0.42)'; ctx.shadowBlur=P.mapCard.shadowBlur; ctx.shadowOffsetY=P.mapCard.shadowOffsetY;
  roundRect(ctx, cardX, mapTop, cardW, cardH, P.mapCard.radius);
  ctx.fillStyle='#0f2550';
  ctx.fill();
  ctx.restore();

  // Draw the map image INSIDE the card (fit/contain)
  const ratio = mapCanvas.width / mapCanvas.height;
  let drawW = cardW * 0.94; // small inner pad for breathing
  let drawH = drawW / ratio;
  if(drawH > cardH * 0.74){ drawH = cardH * 0.74; drawW = drawH * ratio; }
  const drawX = Math.round(cardX + (cardW-drawW)/2);
  const drawY = Math.round(mapTop + (cardH-drawH)/2);

  ctx.save();
  roundRect(ctx, cardX, mapTop, cardW, cardH, P.mapCard.radius);
  ctx.clip();
  ctx.drawImage(mapCanvas, drawX, drawY, drawW, drawH);
  ctx.restore();

  /* Trip list header */
  const listHeaderY = mapTop + cardH + P.listHeaderGap;
  ctx.fillStyle='#eaf2ff';
  ctx.shadowColor='rgba(0,0,0,0.30)'; ctx.shadowBlur=8; ctx.shadowOffsetY=2;
  ctx.font='900 72px Impact, Haettenschweiler, "Arial Black", system-ui, sans-serif';
  ctx.fillText('Highlighted  road trips:', 60, listHeaderY);

  /* Trip bullets */
  const startY = listHeaderY + P.listStartGap;
  const gap = P.bullet.lineGap;
  const tripSummaries=trips.map(t=>({id:t.id,color:t.color,name:t.name,miles:totalTripMiles(t)})).sort((a,b)=>b.miles-a.miles);
  ctx.font='900 42px Impact, Haettenschweiler, "Arial Black", system-ui, sans-serif';
  ctx.shadowColor='rgba(0,0,0,0.28)'; ctx.shadowBlur=6; ctx.shadowOffsetY=2;

  tripSummaries.forEach((row,i)=>{
    const y=startY+i*gap;
    ctx.fillStyle=row.color; ctx.fillRect(60, y+P.bullet.dashOffsetY, P.bullet.dashW, P.bullet.dashH);
    ctx.fillStyle='#eaf2ff'; ctx.fillText(`${formatMiles(row.miles)}: ${row.name}`, 60+P.bullet.dashW+22, y);
  });

  /* Vertical watermark */
  ctx.save();
  ctx.translate(POSTER_W - P.watermarkRightPad, POSTER_H - POSTER_LAYOUT.SAFE_BOTTOM + P.watermarkRaise);
  ctx.rotate(-Math.PI/2);
  ctx.fillStyle='#eaf2ff';
  ctx.shadowColor='rgba(0,0,0,0.35)'; ctx.shadowBlur=6; ctx.shadowOffsetY=2;
  ctx.font='900 120px Impact, Haettenschweiler, "Arial Black", system-ui, sans-serif';
  ctx.fillText(WATERMARK_TEXT, 0, 0);
  ctx.restore();

  return canvas;
}

/* ===== Save/Share/Feedback ===== */
document.getElementById('miSave').addEventListener('click', async ()=>{
  menu.classList.remove('show');
  try{
    document.body.classList.add('exporting'); // hide badges, neutralize transforms
    await new Promise(r=>requestAnimationFrame(r));
    const mapShot=await html2canvas(document.getElementById('map'),{useCORS:true,backgroundColor:null,scale:2});
    document.body.classList.remove('exporting');

    const poster=await buildPosterCanvas(mapShot);
    const a=document.createElement('a'); a.href=poster.toDataURL('image/png'); a.download=`onlyroads_poster_${Date.now()}.png`; a.click();
  }catch(e){ console.error(e); toast('Could not create image'); }
});
document.getElementById('miShare').addEventListener('click', async ()=>{
  menu.classList.remove('show');
  const url=location.href;
  try{ if(navigator.share){ await navigator.share({title:'OnlyRoads',url}); toast('Shared'); } else { await navigator.clipboard.writeText(url); toast('Link copied'); } }
  catch(e){}
});
document.getElementById('miFeedback').addEventListener('click',()=>{
  menu.classList.remove('show');
  location.href=`mailto:?subject=${encodeURIComponent('OnlyRoads feedback')}&body=${encodeURIComponent('Feedback:\n\n')}`;
});

/* ===== Boot ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  initMap();
  updateEmptyState();
});
</script>
</body>
</html>
