<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OnlyRoads — Beta</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-curve"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

<style>
:root{
  --bg:#0b1c3a; --header:#081733;
  --ink:#e6ecff; --ink-dim:#c9d6ff;
  --panel:#0e2349; --panelBorder:#2a3c67;
  --accent:#45a3ff;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

/* Header reveal */
header{position:sticky;top:0;background:var(--header);border-bottom:1px solid #1f3159;box-shadow:0 6px 18px rgba(0,0,0,.28);z-index:10000;transition:transform 220ms ease;will-change:transform}
header.is-hidden{transform:translateY(-100%)} header.force-show{transform:translateY(0)!important}
.header-inner{max-width:980px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:10px 12px 8px}
.brand{font-family:Impact,Haettenschweiler,"Arial Black",Anton,system-ui,sans-serif;font-weight:800;letter-spacing:.3px;font-size:clamp(18px,4.8vw,26px)}

/* Kebab (SVG) */
.icon-btn{width:44px;height:44px;border-radius:12px;border:1px solid #263a6a;background:#112553;color:#fff;display:grid;place-items:center;cursor:pointer}
.icon-btn:hover{background:#153063}
.icon-btn svg{width:20px;height:20px;display:block;fill:#fff;opacity:.95}

/* Layout */
.wrap{max-width:980px;margin:0 auto;padding:8px 12px 18px}
.map-wrap{position:relative}
#map{width:100%;aspect-ratio:21/7;min-height:200px;border-radius:14px;border:1px solid #233a6b;background:#0e2349;margin:8px 0 6px;overflow:hidden;position:relative}
#mapCounter{position:absolute;left:12px;bottom:12px;background:rgba(8,23,51,.88);color:#fff;border:1px solid #ffffff2d;padding:6px 10px;border-radius:10px;font:800 clamp(14px,3.8vw,18px)/1 Impact,system-ui,sans-serif;letter-spacing:.5px}
#fabAddTrip{position:absolute;right:12px;bottom:12px;z-index:9000;width:46px;height:46px;border-radius:14px;border:1px solid #284079;background:#16306a;color:#fff;font-size:24px;font-weight:700;display:grid;place-items:center;cursor:pointer;pointer-events:auto}
#fabAddTrip:hover{background:#1a3a80}

/* Clickable hint */
#belowHint{display:none;margin:8px 2px 12px;padding:16px 14px;border:2px dotted var(--panelBorder);border-radius:12px;background:transparent;color:var(--ink-dim);text-align:center;font-size:14px;letter-spacing:.2px;cursor:pointer;user-select:none}
#belowHint:active{transform:scale(.99)}

/* Trip bar */
.tripbar{display:none;align-items:center;gap:10px;margin:8px 0;flex-wrap:nowrap}
.tripbar.show{display:flex}
.tripbar .tripname{flex:1;min-width:0;background:var(--panel);border:1px solid var(--panelBorder);color:var(--ink);border-radius:12px;padding:10px 12px;font-size:15px;height:42px;line-height:20px}
.mini{width:42px;height:42px;border-radius:12px;border:1px solid var(--panelBorder);background:#1a2f5a;color:#fff;display:grid;place-items:center;cursor:pointer;flex:0 0 auto}
.mini:hover{background:#21366a}
.mini .color-chip{width:22px;height:22px;border-radius:6px;border:1px solid #ffffff55;display:block}
.mini svg{width:18px;height:18px;display:block;stroke:#fff;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

/* City controls + autocomplete */
.controls{display:none;gap:10px;position:relative}
.controls.show{display:flex}
.controls input{flex:1;background:var(--panel);border:1px solid var(--panelBorder);color:var(--ink);border-radius:10px;padding:12px 14px;font-size:16px}
.ac{position:absolute;top:48px;left:0;right:0;z-index:5000;background:var(--panel);border:1px solid var(--panelBorder);border-radius:10px;max-height:260px;overflow:auto;display:none;box-shadow:0 12px 30px rgba(0,0,0,.35)}
.ac.show{display:block}
.ac-item{padding:10px 12px;border-bottom:1px solid #192d56;cursor:pointer}
.ac-item:hover{background:#153063}

/* City list */
.list{display:none;margin-top:10px;border:1px dashed var(--panelBorder);border-radius:12px;padding:8px;min-height:60px;position:relative}
.list.show{display:block}
.li{display:flex;align-items:center;gap:10px;background:#102652;border:1px solid #233a6b;color:#var(--ink);padding:10px 12px;border-radius:10px;margin:6px 0;cursor:grab}
.li .handle{font-size:18px;opacity:.8}
.li .name{flex:1}
.li .remove{background:transparent;border:none;color:#cdd6ff;font-size:18px;cursor:pointer}
.li.li-selected{background:#224080}
.empty-list-hint{position:absolute;inset:0;display:none;place-items:center;color:#c9d6ff;opacity:.9;font-size:13px}

/* Legend */
.legend{display:none;flex-wrap:wrap;gap:10px;margin:6px 2px 0}
.legend.show{display:flex}
.legend .item{display:flex;align-items:center;gap:8px;background:#0f2550;border:1px solid #223a6c;padding:6px 10px;border-radius:12px;font-size:13px;color:#e8f0ffb3;cursor:pointer;outline:none}
.legend .item:hover{background:#153063}
.legend .item.is-active{border-color:#3a58a2;color:#e8f0ff;box-shadow:0 0 0 2px #3a58a215 inset}
.legend .chip{width:14px;height:14px;border-radius:50%;border:1px solid #fff6}

/* Menu (anchored to kebab — fixed) */
.menu{position:fixed; z-index:11000;background:#0f2550;border:1px solid #223a6c;border-radius:12px;min-width:230px;display:none;box-shadow:0 12px 30px rgba(0,0,0,.35);overflow:hidden}
.menu.show{display:block}
.mi{padding:10px 14px;border-bottom:1px solid #193566;cursor:pointer;font-size:14.5px;letter-spacing:.2px}
.mi:last-child{border-bottom:none}
.mi:hover{background:#153063}

.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#102652;color:#fff;border:1px solid #223a6c;border-radius:10px;padding:10px 14px;z-index:12000;display:none}
.toast.show{display:block}
footer{color:#9fb0df65;text-align:center;font-size:12px;padding:10px 0 16px}

/* Visual effects */
.or-marker-glow{ filter:url(#or-soft-glow); }

/* Color picker popover */
.cp-pop{position:absolute;z-index:12000;background:#0f2550;border:1px solid #223a6c;border-radius:12px;padding:10px;box-shadow:0 12px 30px rgba(0,0,0,.35);width:min(260px, 92vw)}
.cp-row{display:flex;flex-wrap:wrap;gap:10px}
.cp-swatch{width:28px;height:28px;border-radius:8px;border:1px solid #ffffff55;cursor:pointer}
.cp-actions{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
.cp-chip{display:inline-grid;grid-auto-flow:column;gap:8px;align-items:center;background:#1a2f5a;border:1px solid var(--panelBorder);color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
.cp-chip input[type="color"]{appearance:none;border:none;background:transparent;width:0;height:0;padding:0;margin:0}
.cp-btn{background:#1a2f5a;border:1px solid var(--panelBorder);color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
.cp-btn:hover,.cp-chip:hover{background:#21366a}

/* ===== Poster Preview overlay ===== */
#orPosterOverlay{position:fixed;inset:0;z-index:12050;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;padding:16px}
.orPosterCard{background:#0b1c3a;border:1px solid #223a6c;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.45);padding:12px;max-width:96vw;max-height:96vh;display:flex;flex-direction:column;gap:10px}
.orPosterTop{display:flex;align-items:center;justify-content:space-between;padding:2px 6px 0}
.orPosterTitle{font-weight:700;letter-spacing:.3px;font-size:14px;color:#c9d6ff}
.orPosterBtns{display:flex;gap:8px}
.orPosterBtn{background:#1a2f5a;border:1px solid #2a3c67;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
.orPosterBtn:hover{background:#21366a}
.orPosterStage{display:grid;place-items:center;overflow:auto}
.orPosterCanvas{width:min(360px, 70vw);height:auto;border-radius:10px;display:block}
@media (min-width: 720px){ .orPosterCanvas{ width:min(540px, 70vw);} }
@media (min-width: 1024px){ .orPosterCanvas{ width:min(660px, 70vw);} }

@media (max-width: 640px){
  #map{aspect-ratio: 21/10;}
}
</style>
</head>
<body>
<!-- SVG filters -->
<svg width="0" height="0" style="position:absolute;left:-9999px;top:-9999px" aria-hidden="true" focusable="false">
  <defs>
    <filter id="or-soft-glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur stdDeviation="2.8" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
  </defs>
</svg>

<header>
  <div class="header-inner">
    <div class="brand">OnlyRoads</div>
    <button class="icon-btn" id="kebabBtn" aria-label="More">
      <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="5" cy="12" r="2.2"/><circle cx="12" cy="12" r="2.2"/><circle cx="19" cy="12" r="2.2"/></svg>
    </button>
    <div class="menu" id="menu">
      <div class="mi" id="miSave">Save image</div>
      <div class="mi" id="miShare">Share link</div>
      <div class="mi" id="miFeedback">Leave feedback</div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="map-wrap" id="mapWrap">
    <div id="map"></div>
    <div id="mapCounter">0/50</div>
    <button id="fabAddTrip" title="New Trip" aria-label="New Trip">+</button>
  </div>

  <div id="belowHint" role="button" tabindex="0" aria-label="Create a trip">Tap + to create your first trip</div>

  <div class="tripbar" id="tripBar">
    <select id="tripSelect" class="tripname" aria-label="Select trip"></select>
    <button class="mini" id="tripColorBtn" title="Trip color" aria-label="Trip color"><span id="tripColorChip" class="color-chip"></span></button>
    <button class="mini" id="renameTripBtn" title="Rename trip" aria-label="Rename trip"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 21h4l11-11-4-4L3 17v4z"/><path d="M14 6l4 4"/></svg></button>
    <button class="mini" id="deleteTripBtn" title="Delete trip" aria-label="Delete trip"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M6 6l1 14h10l1-14"/></svg></button>
  </div>

  <div class="controls" id="controls">
    <input id="cityInput" placeholder="Type a U.S. city to add" aria-label="City search"/>
    <div id="ac" class="ac" role="listbox" aria-label="City results"></div>
  </div>

  <div class="list" id="cityList"><div id="emptyListHint" class="empty-list-hint"></div></div>
  <div class="legend" id="legend"></div>
</div>

<footer id="footerNote"></footer>
<div class="toast" id="toast" role="status" aria-live="polite"></div>

<!-- Color picker popover -->
<div id="colorPicker" class="cp-pop" hidden>
  <div class="cp-row" id="cpSwatches"></div>
  <div class="cp-actions">
    <label class="cp-chip"><input type="color" id="cpCustom" aria-label="Custom color"/>Custom…</label>
    <button id="cpClose" class="cp-btn">Done</button>
  </div>
</div>

<script>
/* ===== Version constant ===== */
const VERSION = '0.123';
document.addEventListener('DOMContentLoaded', ()=>{
  document.title = `OnlyRoads — Beta v${VERSION}`;
  document.getElementById('footerNote').textContent = `OnlyRoads Beta v${VERSION} - Emin's personal project`;
});

/* ===== Constants / helpers ===== */
const STATE_ABBR={"Alabama":"AL","Alaska":"AK","Arizona":"AZ","Arkansas":"AR","California":"CA","Colorado":"CO","Connecticut":"CT","Delaware":"DE","District of Columbia":"DC","Florida":"FL","Georgia":"GA","Hawaii":"HI","Idaho":"ID","Illinois":"IL","Indiana":"IN","Iowa":"IA","Kansas":"KS","Kentucky":"KY","Louisiana":"LA","Maine":"ME","Maryland":"MD","Massachusetts":"MA","Michigan":"MI","Minnesota":"MN","Mississippi":"MS","Missouri":"MO","Montana":"MT","Nebraska":"NE","Nevada":"NV","New Hampshire":"NH","New Jersey":"NJ","New Mexico":"NM","New York":"NY","North Carolina":"NC","North Dakota":"ND","Ohio":"OH","Oklahoma":"OK","Oregon":"OR","Pennsylvania":"PA","Rhode Island":"RI","South Carolina":"SC","South Dakota":"SD","Tennessee":"TN","Texas":"TX","Utah":"UT","Vermont":"VT","Virginia":"VA","Washington":"WA","West Virginia":"WV","Wisconsin":"WI","Wyoming":"WY"};
const ABBR_TO_NAME=Object.fromEntries(Object.entries(STATE_ABBR).map(([k,v])=>[v,k]));
function canonicalStateName(n){ if(!n) return null; const s=String(n).trim();
  if(STATE_ABBR[s]) return s; const ab=s.toUpperCase(); if(ABBR_TO_NAME[ab]) return ABBR_TO_NAME[ab];
  if(["washington, d.c.","district of columbia","washington dc"].includes(s.toLowerCase())) return "District of Columbia";
  return s;
}
const PALETTE=['#45a3ff','#ff6b6b','#ffd166','#06d6a0','#c792ea','#ff9f1c','#00bcd4','#ef476f','#8ac926','#a0a0ff'];

const DOT_RADIUS=3.5, DOT_WEIGHT=1, RED='#ff0000', GREEN='#30e6b6';
const CURVE_GAIN=1.25;

/* Fit config */
const MAP_MARGINS = { top:5, right:5, bottom:5, left:5 };
const POSTER_SIDE_MARGIN = 35; // exact gutters
const POSTER_MAP_WIDTH = 1010; // hard-coded map width
const HEIGHT_FIT_SAFETY = 1;

const mapCounter=document.getElementById('mapCounter');
const belowHint=document.getElementById('belowHint');
const tripBar=document.getElementById('tripBar'),
      tripSelect=document.getElementById('tripSelect'),
      tripColorChip=document.getElementById('tripColorChip'),
      tripColorBtn=document.getElementById('tripColorBtn');

const controls=document.getElementById('controls'),
      input=document.getElementById('cityInput'),
      ac=document.getElementById('ac');

const list=document.getElementById('cityList'), emptyListHint=document.getElementById('emptyListHint');
const legendEl=document.getElementById('legend');
const toastEl=document.getElementById('toast'); let toastTimer=null;
function toast(t){toastEl.textContent=t;toastEl.classList.add('show');clearTimeout(toastTimer);toastTimer=setTimeout(()=>toastEl.classList.remove('show'),1600);}

/* Color picker refs */
const cp=document.getElementById('colorPicker'), cpSwatches=document.getElementById('cpSwatches'), cpCustom=document.getElementById('cpCustom'), cpClose=document.getElementById('cpClose');

/* ===== App state ===== */
let trips=[],activeTripId=null,tripCounter=0,cidCounter=0,selectedId=null;
function getActiveTrip(){return trips.find(t=>t.id===activeTripId);}

/* ===== Header/menu ===== */
const kebabBtn=document.getElementById('kebabBtn'); const menu=document.getElementById('menu');
(function(){
  const headerEl=document.querySelector('header'); if(!headerEl) return;
  let lastY=window.scrollY,ticking=false,hidden=false;
  const DELTA=6,REVEAL_AT_TOP=16;
  function hide(){ if(headerEl.classList.contains('force-show')) return; if(!hidden){headerEl.classList.add('is-hidden'); hidden=true;}}
  function show(){ if(hidden){headerEl.classList.remove('is-hidden'); hidden=false;}}
  function onScrollFrame(){ const y=window.scrollY; if(y<=REVEAL_AT_TOP){show(); lastY=y; return;} const diff=y-lastY; if(Math.abs(diff)<DELTA) return; diff>0?hide():show(); lastY=y; }
  window.addEventListener('scroll',()=>{ if(!ticking){ requestAnimationFrame(()=>{ onScrollFrame(); ticking=false;}); ticking=true;}},{passive:true});
  window.OnlyRoadsHeader={forceShow(on=true){ headerEl.classList.toggle('force-show',!!on); if(on) headerEl.classList.remove('is-hidden'); }, show, hide};
})();

/* Anchored menu positioning */
function positionMenu(){
  if(!menu.classList.contains('show')) return;
  const r=kebabBtn.getBoundingClientRect();
  const margin=8;
  const left=Math.min(Math.max(8, r.right - menu.offsetWidth), window.innerWidth - menu.offsetWidth - 8);
  const top=Math.min(r.bottom + margin, window.innerHeight - menu.offsetHeight - 8);
  menu.style.left = `${left}px`;
  menu.style.top  = `${top}px`;
}
kebabBtn.addEventListener('click',(e)=>{
  e.stopPropagation();
  const willShow=!menu.classList.contains('show');
  if(willShow){ menu.classList.add('show'); positionMenu(); }
  else { menu.classList.remove('show'); }
  window.OnlyRoadsHeader?.forceShow(willShow);
});
window.addEventListener('resize, scroll', positionMenu, {passive:true});
document.addEventListener('click',e=>{
  const outside=!menu.contains(e.target)&&e.target!==kebabBtn;
  if(outside&&menu.classList.contains('show')){ menu.classList.remove('show'); window.OnlyRoadsHeader?.forceShow(false); }
});

/* ===== Poster (hard-coded 1010px map width, centered with 35px gutters) ===== */
document.getElementById('miSave').addEventListener('click', async ()=>{
  menu.classList.remove('show'); window.OnlyRoadsHeader?.forceShow(false);
  try{
    const overlay = createPosterOverlay();
    document.body.appendChild(overlay.el);

    // Offscreen poster surface (outer) at 1080x1920
    const workOuter = document.createElement('div');
    workOuter.style.position='absolute'; workOuter.style.left='-99999px'; workOuter.style.top='-99999px';
    workOuter.style.width='1080px'; workOuter.style.height='1920px';
    document.body.appendChild(workOuter);

    // Inner map container at exactly 1010px width, full height; centered would be 35px margins
    const work = document.createElement('div');
    work.style.width = POSTER_MAP_WIDTH + 'px';
    work.style.height = '1920px';
    workOuter.appendChild(work);

    // Leaflet map on the 1010px-wide container
    const posterMap = L.map(work,{
      zoomControl:false,attributionControl:false,
      dragging:false,scrollWheelZoom:false,doubleClickZoom:false,
      boxZoom:false,keyboard:false,touchZoom:false,worldCopyJump:false,
      zoomSnap:0, zoomDelta:0.25, preferCanvas:true, fadeAnimation:false, zoomAnimation:false
    });
    posterMap.invalidateSize(true);

    // Load states and draw
    const geo = await fetch("https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json").then(r=>r.json());
    const conus = geo.features.filter(f=>!["Alaska","Hawaii","Puerto Rico"].includes(f.properties.name));
    const statesFC = {type:"FeatureCollection",features:conus};

    const unlocked = new Set();
    trips.forEach(t=>t.cities.forEach(c=>{
      const canon = canonicalStateName(c.stateFull||c.stateAbbr);
      if(canon) unlocked.add(canon);
    }));

    const statesLayerPoster = L.geoJSON(statesFC,{
      renderer: L.canvas(),
      style: f=>{
        const name=f.properties?.name;
        if(unlocked.has(name)) return {color:'#0b1c3a',weight:2,fillColor:'#ffffff',fillOpacity:1};
        return {color:'#ffffff',weight:1,fillColor:'#0b1c3a',fillOpacity:1};
      }
    }).addTo(posterMap);

    const conusBoundsPoster = statesLayerPoster.getBounds();

    // Fit by width within the 1010px container (no side padding inside the map)
    fitByWidthPoster(posterMap, conusBoundsPoster, {left:0, right:0, top:0, bottom:0});

    // Allow Canvas render to flush
    await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));

    // Extract Leaflet's canvas and translate to poster canvas
    const activeRenderer = posterMap.getRenderer(statesLayerPoster);
    const src = (typeof activeRenderer.getContainer === 'function')
                  ? activeRenderer.getContainer()
                  : activeRenderer._container; // <canvas>
    if(!(src instanceof HTMLCanvasElement)) throw new Error('Poster renderer canvas not found');

    const {tx,ty} = parseTranslate(src.style.transform);
    const ratioX = src.width  / work.clientWidth;   // DPR scale
    const ratioY = src.height / work.clientHeight;

    const dst = overlay.canvas; // 1080 x 1920
    const dctx = dst.getContext('2d');
    dctx.fillStyle='#0b1c3a';
    dctx.fillRect(0,0,dst.width,dst.height);

    // Crop from source canvas using DPR-aware offsets
    const sx = Math.max(0, -tx * ratioX);
    const sy = Math.max(0, -ty * ratioY);
    const sw = POSTER_MAP_WIDTH * ratioX; // exact 1010px width in source pixels
    const sh = dst.height * ratioY;       // full height

    // Draw the 1010px-wide map centered at x=35 on the poster canvas
    dctx.drawImage(src, sx, sy, sw, sh, POSTER_SIDE_MARGIN, 0, POSTER_MAP_WIDTH, dst.height);

    // === Manual overlays (routes & markers), projected via posterMap ===
    dctx.lineCap='round'; dctx.lineJoin='round';

    // Routes
    for(const t of trips){
      if(!t.cities || t.cities.length<2) continue;
      const pts = t.cities.map(c=>[c.lat,c.lon]);
      const closed = (()=>{ if(pts.length<3) return false; const a=pts[0], b=pts[pts.length-1]; return Math.hypot(a[0]-b[0], a[1]-b[1])<0.6; })();
      const path=buildSmoothPathAdaptive(pts,{closed});
      if(!path) continue;
      // shift drawing by +35px since our map is inset
      drawPathLatLngShifted(dctx, posterMap, path, t.color||'#45a3ff', 3, POSTER_SIDE_MARGIN, 0);
    }

    // Markers
    for(const t of trips){
      for(const c of t.cities||[]){
        const p = posterMap.latLngToContainerPoint([c.lat,c.lon]);
        drawMarker(dctx, POSTER_SIDE_MARGIN + p.x, p.y, 4, '#ffffff', 1, '#ff0000');
      }
    }

    // Cleanup
    posterMap.remove(); workOuter.remove();
  }catch(err){
    console.error(err);
    toast('Could not create poster');
  }
});

// Poster helpers (with horizontal shift to account for 35px inset)
function drawPathLatLngShifted(ctx, map, path, color, width, dx, dy){
  ctx.beginPath();
  for(let i=0;i<path.length;){
    const cmd = path[i];
    if(cmd==='M'){
      const p = map.latLngToContainerPoint(path[i+1]);
      ctx.moveTo(dx + p.x, dy + p.y);
      i+=2;
    }else if(cmd==='C'){
      const c1 = map.latLngToContainerPoint(path[i+1]);
      const c2 = map.latLngToContainerPoint(path[i+2]);
      const p  = map.latLngToContainerPoint(path[i+3]);
      ctx.bezierCurveTo(dx + c1.x,dy + c1.y,dx + c2.x,dy + c2.y,dx + p.x,dy + p.y);
      i+=4;
    }else if(cmd==='Z'){
      ctx.closePath(); i+=1;
    }else{
      i+=1;
    }
  }
  ctx.strokeStyle=color;
  ctx.lineWidth=width;
  ctx.stroke();
}
function drawMarker(ctx, x, y, r, stroke, sw, fill){
  ctx.beginPath();
  ctx.arc(x,y,r,0,Math.PI*2);
  ctx.fillStyle=fill; ctx.fill();
  ctx.lineWidth=sw; ctx.strokeStyle=stroke; ctx.stroke();
}
function parseTranslate(transformStr){
  const s = transformStr || '';
  const m3 = /translate3d\(\s*([-\d.]+)px\s*,\s*([-\d.]+)px/i.exec(s);
  if(m3) return {tx:parseFloat(m3[1])||0, ty:parseFloat(m3[2])||0};
  const m2 = /translate\(\s*([-\d.]+)px\s*,\s*([-\d.]+)px/i.exec(s);
  if(m2) return {tx:parseFloat(m2[1])||0, ty:parseFloat(m2[2])||0};
  return {tx:0, ty:0};
}
function fitByWidthPoster(m, bounds, pad){
  const left=pad.left||0, right=pad.right||0, top=pad.top||0, bottom=pad.bottom||0;
  m.fitBounds(bounds,{paddingTopLeft:[left,top], paddingBottomRight:[right,bottom], animate:false});

  const size=m.getSize();
  const targetW = Math.max(1, size.x - (left+right));
  const nw=bounds.getNorthWest(), ne=bounds.getNorthEast(), sw=bounds.getSouthWest();
  const pW=m.latLngToLayerPoint(nw), pE=m.latLngToLayerPoint(ne);
  const curW=Math.abs(pE.x - pW.x);
  if(curW>0){
    const factor=targetW/curW;
    if(factor>0 && Math.abs(factor-1)>1e-6) m.setZoom(m.getZoom()+Math.log2(factor),{animate:false});
  }
}

/* ===== Share & feedback ===== */
document.getElementById('miShare').addEventListener('click', async ()=>{
  menu.classList.remove('show'); window.OnlyRoadsHeader?.forceShow(false);
  const url=updateShareURL();
  try{
    if(navigator.share){ await navigator.share({title:'OnlyRoads',url}); toast('Shared'); }
    else { await navigator.clipboard.writeText(url); toast('Link copied'); }
  }catch(e){}
});
document.getElementById('miFeedback').addEventListener('click', ()=>{
  menu.classList.remove('show'); window.OnlyRoadsHeader?.forceShow(false);
  location.href=`mailto:?subject=${encodeURIComponent('OnlyRoads feedback')}&body=${encodeURIComponent('Feedback:\n\n')}`;
});

/* ===== Trips UI (unchanged) ===== */
function refreshTripUI(){
  tripSelect.innerHTML='';
  trips.forEach(t=>{const o=document.createElement('option');o.value=t.id;o.textContent=t.name;if(t.id===activeTripId)o.selected=true;tripSelect.appendChild(o);});
  const act=getActiveTrip(); tripColorChip.style.background = act ? act.color : 'transparent';
  renderLegend();
}
tripSelect.addEventListener('change',()=>{activeTripId=+tripSelect.value||null; renderList(); updateMap(); updateEmptyState(); highlightLegendActive();});

/* Empty state */
function updateEmptyState(){
  const hasTrip = trips.length>0;
  belowHint.style.display = hasTrip ? 'none' : 'block';
  tripBar.classList.toggle('show', hasTrip);
  controls.classList.toggle('show', hasTrip);
  list.classList.toggle('show', hasTrip);
  legendEl.classList.toggle('show', hasTrip);
}

/* Create / rename / delete trips */
function createTripFlow(){
  try{
    const raw=prompt('Name your new trip:', '');
    if(raw===null) return;
    const name=(raw||'').trim();
    addTrip(name);
  }catch(e){
    console.error('createTripFlow error:', e);
    toast('Could not create new trip');
  }
}
function addTrip(name){
  const id=++tripCounter;
  const t={ id, name: name || `Trip ${id}`, color: PALETTE[(id-1)%PALETTE.length], cities:[] };
  trips.push(t);
  activeTripId=id;

  refreshTripUI();
  renderList();
  recomputeUnlockedFromCities();
  updateMap();
  updateEmptyState();
  updateShareURL();

  toast(`Created trip “${t.name}”`);
}
document.getElementById('fabAddTrip').addEventListener('click', createTripFlow);
belowHint.addEventListener('click', createTripFlow);
belowHint.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); createTripFlow(); } });

document.getElementById('renameTripBtn').addEventListener('click',()=>{
  const t=getActiveTrip(); if(!t){toast('No trip');return;}
  const raw=prompt('Rename trip:', t.name||''); if(raw===null)return;
  const n=(raw||'').trim();
  if(n){t.name=n; refreshTripUI(); updateShareURL();}
});
document.getElementById('deleteTripBtn').addEventListener('click',()=>{
  const t=getActiveTrip(); if(!t) return; if(!confirm(`Delete “${t.name}”?`)) return;
  trips=trips.filter(x=>x.id!==t.id); activeTripId=trips.length?trips[trips.length-1].id:null;
  recomputeUnlockedFromCities(); updateMap(); renderList(); refreshTripUI(); updateEmptyState(); updateShareURL();
});

/* ===== Color picker ===== */
(function initColorPicker(){
  const tripColorBtn=document.getElementById('tripColorBtn');
  const tripColorChip=document.getElementById('tripColorChip');
  const cp=document.getElementById('colorPicker');
  const cpSwatches=document.getElementById('cpSwatches');
  const cpCustom=document.getElementById('cpCustom');
  const cpClose=document.getElementById('cpClose');

  cpSwatches.innerHTML='';
  PALETTE.forEach(hex=>{
    const b=document.createElement('button'); b.className='cp-swatch'; b.style.background=hex; b.setAttribute('aria-label',`Choose ${hex}`);
    b.addEventListener('click', ()=>applyTripColor(hex,true));
    cpSwatches.appendChild(b);
  });
  function positionPopover(){
    const r=tripColorBtn.getBoundingClientRect();
    cp.style.top=`${r.bottom+window.scrollY+8}px`;
    const maxLeft=window.scrollX+document.documentElement.clientWidth-cp.offsetWidth-8;
    cp.style.left=`${Math.min(r.left+window.scrollX,maxLeft)}px`;
  }
  function openPopover(){ if(cp.hidden){ cp.hidden=false; requestAnimationFrame(()=>{ positionPopover(); }); } }
  function closePopover(){ cp.hidden=true; }
  tripColorBtn.addEventListener('click',(e)=>{ e.stopPropagation(); openPopover(); });
  cpClose.addEventListener('click', closePopover);
  cpCustom.addEventListener('input', ()=> applyTripColor(cpCustom.value, true));
  document.addEventListener('click',(e)=>{ if(!cp.hidden && !cp.contains(e.target) && e.target!==tripColorBtn) closePopover(); });
  document.addEventListener('keydown', (e)=>{ if(!cp.hidden && e.key==='Escape') closePopover();});
  window.addEventListener('resize', ()=>{ if(!cp.hidden) positionPopover(); });
  window.applyTripColor=function(hex,persist){
    const t=getActiveTrip(); if(!t) return;
    t.color=hex;
    tripColorChip.style.background=hex;
    renderLegend();
    updateMap();
    if(persist) updateShareURL();
  };
})();

/* ===== Autocomplete (unchanged) ===== */
let acTimer=null;
let acItemsCache=[];
const headerEl = document.querySelector('header');
function headerHeight(){ return headerEl?.getBoundingClientRect().height || 0; }
function ensureCityBoxVisible(instant=false){ const r=controls.getBoundingClientRect(); const topTarget=(window.scrollY+r.top)-headerHeight()-8; window.scrollTo({top:Math.max(0,topTarget),behavior:instant?'auto':'smooth'}); }
function resizeAutocompleteForViewport(){ const inputRect=input.getBoundingClientRect(); const vv=window.visualViewport; const viewportBottom=vv?(vv.offsetTop+vv.height):window.innerHeight; const available=Math.max(120,viewportBottom-inputRect.bottom-8); ac.style.maxHeight=`${Math.floor(available)}px`; }
function keyboardAwarePadding(on){ if(on && window.visualViewport){ const vv=window.visualViewport; const kb=Math.max(0, window.innerHeight - (vv.height||window.innerHeight)); document.body.style.paddingBottom=`${kb+16}px`; }else{ document.body.style.paddingBottom=''; }

function handlePickIndex(idx){
  const it = acItemsCache[idx];
  if(!it) return;
  ac.classList.remove('show');
  input.value='';
  addCity(it);
  input.blur();
}
function delegatedPickHandler(e){
  const item = e.target.closest('.ac-item');
  if(!item || !ac.contains(item)) return;
  e.preventDefault();
  e.stopPropagation();
  const idx = +item.dataset.i;
  handlePickIndex(idx);
}
ac.addEventListener('pointerdown', delegatedPickHandler, {capture:true});
ac.addEventListener('mousedown', delegatedPickHandler, {capture:true});
ac.addEventListener('touchstart', delegatedPickHandler, {capture:true, passive:false});

input.addEventListener('focus', ()=>{ ensureCityBoxVisible(false); resizeAutocompleteForViewport(); keyboardAwarePadding(true); });
input.addEventListener('input', ()=>{
  const q=input.value.trim();
  if(acTimer)clearTimeout(acTimer);
  if(!q){ac.classList.remove('show');ac.innerHTML='';acItemsCache=[];return;}
  acTimer=setTimeout(()=>fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&countrycodes=us&limit=6&q=${encodeURIComponent(q)}`)
    .then(r=>r.json()).then(rows=>{
      ac.innerHTML='';
      acItemsCache = rows.map(row=>{
        const a=row.address||{};
        const cityName=a.city||a.town||a.village||a.hamlet||row.display_name.split(',')[0];
        const stateFull=canonicalStateName(a.state||'');
        const ab=STATE_ABBR[stateFull]||'';
        if(!cityName||!ab||!stateFull) return null;
        return {label:`${cityName}, ${ab}`, name:cityName, stateFull, stateAbbr:ab, lat:+row.lat, lon:+row.lon};
      }).filter(Boolean);
      if(!acItemsCache.length){ac.classList.remove('show');return;}
      acItemsCache.forEach((it,idx)=>{
        const d=document.createElement('div');
        d.className='ac-item';
        d.dataset.i = String(idx);
        d.textContent=it.label;
        ac.appendChild(d);
      });
      ac.classList.add('show'); resizeAutocompleteForViewport(); ensureCityBoxVisible(true);
    }).catch(()=>{}),200);
});
input.addEventListener('blur', ()=>{ setTimeout(()=>{ ac.classList.remove('show'); keyboardAwarePadding(false); },150); });
if (window.visualViewport) {
  visualViewport.addEventListener('resize', ()=>{ resizeAutocompleteForViewport(); if(document.activeElement===input) ensureCityBoxVisible(true); });
  visualViewport.addEventListener('scroll', resizeAutocompleteForViewport);
}
document.addEventListener('click',e=>{ if(!ac.contains(e.target)&&e.target!==input) ac.classList.remove('show'); });

/* ===== Sortable, Legend, Live Map, Share/Serialize boot (unchanged) ===== */
/* ... keep your existing implementations unchanged ... */

</script>
</body>
</html>
